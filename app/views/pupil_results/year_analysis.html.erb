
			<ul class="nav nav-tabs" id="myTab">
<%@year.each do |y|%>
	<%if y == @year_id.to_i%>
		<li class="active"><%=link_to 'Year ' + y.to_s, year_analysis_pupil_results_path(year_id: y, subject_id: @subject_id, class_id: @class_id, col_id: 1)%></li>
	<%else%>
		<li><%=link_to 'Year ' + y.to_s, year_analysis_pupil_results_path(year_id: y, subject_id: @subject_id, class_id: @class_id, col_id: 1)%></li>
	<%end%>
<%end%>
		<li class="dropdown">
			<a class="dropdown-toggle" data-toggle="dropdown" href="#">
			  Groups<span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
					<%@groups.each do |g|%>
						<li><%=link_to g.group, year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, class_id: @class_id,group_id: g.id, col_id: 1)%></li>
					<%end%>
					<li><%=link_to 'All Pupils', year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, class_id: @class_id, col_id: 1)%></li>
			</ul>
		</li>
		
		<li class="dropdown">
			<a class="dropdown-toggle" data-toggle="dropdown" href="#">
			  Assessments<span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
					<%(1..50).each do |t|%>
						<li><%=link_to 'Assessment ' + t.to_s, year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, class_id: @class_id, group_id: @group_id, col_id: t)%></li>
					<%end%>
			</ul>
		</li>
		
		<li class="dropdown">
			<a class="dropdown-toggle" data-toggle="dropdown" href="#">
			  Classes<span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
					<%@classes.each do |c|%>
						<li><%=link_to c.class_name, year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, class_id: c.id, group_id: @group_id, col_id: @col_id)%></li>
					<%end%>
					<li><%=link_to 'All Classes', year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, group_id: @group_id, col_id: @col_id)%></li>
			</ul>
		</li>
		<%if @locked == true%>
		<li><%=link_to 'Hide Locked Columns', year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, class_id: @class_id, locked: false, group_id: @group_id, col_id: @col_id)%></li>
		<%else%>
		<li><%=link_to 'Show Locked Columns', year_analysis_pupil_results_path(year_id: @year_id, subject_id: @subject_id, class_id: @class_id,locked:true, group_id: @group_id, col_id: @col_id)%></li>
		<%end%>
		
		</ul>
		<div class="row">
			<% if s = Subject.where(id: @subject_id).first%><%=s.subject%><%end%> | 
			Year <%=@year_id%> | 
			<%if @group_id%>
				<%=Group.where(id: @group_id).first.group%> | 
			<%end%>
			Title <%=@col_id%>
		</div>
<div class="row-fluid" style="margin-top:20px;">
	<div class="col-md-6 col-xs-6">
		<div class="row">
			<div class="col-xs-2 col-md-2">
			Surname
			</div>
			<div class="col-xs-2 col-md-2">
			Forename
			</div>
			<div class="col-xs-2 col-md-2">
			Target
			</div>
			<div class="col-xs-2 col-md-2">
			Result
			</div>
			<div class="col-xs-4 col-md-4">
			Levels of Progress
			</div>
		</div>
		
		<%aps = Array.new%>
		<%@u.each do |p|%>
			<%if a = p.user_info%>
			<%if r = p.pupil_results.where(col_id: @col_id).where(locked: @locked).joins(:class_name).where("class_names.subject_id" => @subject_id).first%>
				<div class="row">
					<div class="col-xs-2">
						<%=a.surname%>
					</div>
					<div class="col-xs-2">
						<%=a.forename%>
					</div>
					<div class="col-xs-2">
						<%if t = p.user_targets.where(subject_id: @subject_id).first%>
							<%if @aps == true%>
								<%=t.result.aps%>
							<%else%>
								<%=t.result.grade%>
							<%end%>
						<%end%>
					</div>
					<div class="col-xs-2">
						<%if t%>
						
							
								<%@difference = r.result.aps - t.result.aps%>
											<%case %>
												<%when @difference >0%>
													<div class="col-xs-1 col-md-1 text-center above_target cell_design">
													<%@above << 1%>
												<%when @difference ==0%>
													<div class="col-xs-1 col-md-1 text-center on_target cell_design">
													<%@on_track << 1%>
												<%when @difference <0 && @difference >=-2 %>
													<div class="col-xs-1 col-md-1 text-center one_below_target cell_design">
													<%@one_below << 1%>
												<%when @difference <-2%>
													<div class="col-xs-1 col-md-1 text-center below_target cell_design">
													<%@below << 1%>
												<%else%>
													<div class="col-xs-1 col-md-1 text-center empty_result cell_design">	
											<%end%>
														<%=r.result.grade %>
														
														<%aps << r.result.aps%>
													</div>
													
						<%else%>
									<div class="col-xs-1 col-md-1 text-center empty_result">
									<%if @r%>
									<%if @aps == true%>
										<%=r.result.aps %>
									<%else%>
										<%=r.result.grade %>
									<%end%>
									
									<%aps << r.result.aps%>
									<%end%>
									</div>
									
									
						<%end%>
						<%end%>

						
					</div>
					<div class="col-xs-4">
							<%if k = Result.where(id: @key_stage.to_s).first%>
								<%if r %>
									<%k.aps%>
									<%r.result.aps%>
									<%diff = r.result.aps- k.aps%>
										
										<%if r.result.aps >80%>
											
											<%(7..53).step(6).each do |n|%>
												<%if k.aps >=n && k.aps <=n+5%>
												
													<%j=79+((n-7)/6)%>
													<%(81..88).each do |i|%>
														<%if r.result.aps == i%>
															<%= level = i-j%> levels
															<% @levels << level%>
														<%end%>
													<%end%>
												<%end%>
											
											<%end%>
										<%end%>
										
										<%if r.result.aps <54%>
											<%if diff == 0%>
												No Progress
											<%end%>
											<%if diff == 1 || diff==2%>
												1 Sub level
											<%end%>
											<%(3..50).step(2).each do |i|%>
												<%if diff==i || diff==i+1%>
													<%=((i+1)/2)%> sub levels
												<%end%>
												<%if diff==(i*-1) || diff==((i+1)*-1)%>
													<%=(((i+1)/2)*-1)%> sub levels
												<%end%>
												<%i=+2%>
											<%end%>
											<% @levels << (diff/2)%>
										<%end%>
									
								<%end%>
							<%end%>
						</div>
				</div>
			<%end%>		
		<%end%>
		
	</div>
	<div class="col-md-6 col-xs-6">
			<%if !aps.empty?%>
				<%avg_aps =(aps.inject{|sum,x| sum + x }.to_f/aps.size).round(0)%>
			<%end%>
				
				<div class="row">
					<div id="chart2" style="width:550px; height:450px;"></div>
					<div id="chart1"  style="width:550px; height:450px;"></div>
					
					<div id="pie_chart" style="width:500px; margin-top:40px; margin-left:auto; margin-right:auto;"></div>
					<div id="pie_chart_levels" style="width:500px; margin-top:40px; margin-left:auto; margin-right:auto;"></div>
				</div>	
							
				
		
		<br />
	
		<br />
		
	</div>
</div>

<%= render "matrix"%>


<%=link_to('Back', subject_choice_pupil_results_path)%>
</div>

		
<script>
$(document).ready(function(){
  var line1 = [
	<%@u.each do |p|%>
		<%if a = p.user_info%>		
			['<%=a.forename%>', <%if r = p.pupil_results.where(col_id: @col_id).where(locked: @locked).joins(:class_name).where("class_names.subject_id" => @subject_id).first%><%=r.result.aps-80%><%end%>],
		<%end%>  
	<%end%>
];
  var line2 = [
  <%@u.each do |p|%>
  	<%if a = p.user_info%>		
		['<%=a.forename%>', <%if t = p.user_targets.where(subject_id: @subject_id).first%><%=t.result.aps-80%><%end%>],
	<%end%>  
  <%end%>
  ];
 
	 tickFormatter = function (format, val) { 
	 if(val==8)
	 {return "A*";}
	else if(val==7)
	 {return "A";}
	 else if(val==6)
	 {return "B";}
	 else if(val==5)
	 {return "C";}
	 else if(val==4)
	 {return "D";}
	 else if(val==3)
	 {return "E";}
	 else if(val==2)
	 {return "F";}
	 else if(val==1)
	 {return "G";}
	 else if(val==0)
	 {return "U";}
  }
  
  var plot1 = $.jqplot('chart1', [line1, line2], {
    series:[{renderer:$.jqplot.BarRenderer}, {xaxis:'x2axis', yaxis:'y2axis'}],
	title:'Assessment Results ',
    axesDefaults: {
		min: 0,
		max: 8,
        tickRenderer: $.jqplot.CanvasAxisTickRenderer ,
        tickOptions: {
          angle: 0,
        }
    },
    axes: {
      xaxis: {
        renderer: $.jqplot.CategoryAxisRenderer,
		label:'Students', 
          labelOptions:{
            fontFamily:'Helvetica',
            fontSize: '12pt'
          },
		  tickOptions: {
          angle: -90,
        },
      },
      x2axis: {
        renderer: $.jqplot.CategoryAxisRenderer,
		tickOptions: {
          show: false,
		  showLabel: false,
		  textColor: '#ffffff'
        },
				  showTicks: false,
				    showTickMarks: false
      },
      yaxis: {
         label: 'Grade',
                labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
		  tickOptions: {
		  formatter: tickFormatter
		  },
		   tickInterval : 1,
		  
      },
      y2axis: {
        autoscale:true,
		tickOptions: {
		  formatter: tickFormatter
		  },
		  tickInterval : 1,
      }
    },
	 highlighter: {
        show: true,
        sizeAdjust: 7.5,
		tooltipAxes: 'y',
		formatString: 'Grade: %s'
      }
      

  });
});
</script>

<script>
$(document).ready(function(){
var line1 = [
	<%@u.each do |p|%>
		<%if a = p.user_info%>		
			['<%=a.forename%>', <%if r = p.pupil_results.where(col_id: @col_id).where(locked: @locked).joins(:class_name).where("class_names.subject_id" => @subject_id).first%><%=r.result.aps%><%end%>],
		<%end%>  
	<%end%>
];
  var line2 = [
  <%@u.each do |p|%>
  	<%if a = p.user_info%>		
		['<%=a.forename%>', <%if t = p.user_targets.where(subject_id: @subject_id).first%><%=t.result.aps%><%end%>],
	<%end%>  
  <%end%>
  ];
 
	 tickFormatter = function (format, val) { 
	 if(val>=53)
	 {return "8a";}
	 else if(val>=51)
	 {return "8b";}
	 else if(val>=49)
	 {return "8c";}
	 else if(val>=47)
	 {return "7a";}
	 else if(val>=45)
	 {return "7b";}
	 else if(val>=43)
	 {return "7c";}
	 else if(val>=41)
	 {return "6a";}
	 else if(val>=39)
	 {return "6b";}
	 else if(val>=37)
	 {return "6c";}
	 else if(val>=35)
	 {return "5a";}
	 else if(val>=33)
	 {return "5b";}
	 else if(val>=31)
	 {return "5c";}
	 else if(val>=29)
	 {return "4a";}
	 else if(val>=27)
	 {return "4b";}
	 else if(val>=25)
	 {return "4c";}
	 else if(val>=23)
	 {return "3a";}
	 else if(val>=21)
	 {return "3b";}
	 else if(val>=19)
	 {return "3c";}
	 else if(val>=17)
	 {return "2a";}
	 else if(val>=15)
	 {return "2b";}
	 else if(val>=13)
	 {return "2c";}
	 else if(val>=11)
	 {return "1a";}
	 else if(val>=9)
	 {return "1b";}
	 else if(val>=7)
	 {return "1c";}
	 else if(val>=3)
	 {return "W";}
  }
  
  var plot2 = $.jqplot('chart2', [line1, line2], {
    series:[{renderer:$.jqplot.BarRenderer}, {xaxis:'x2axis', yaxis:'y2axis'}],
	title:'Assessment Results ',
    axesDefaults: {
		min: 3,
		max: 53,
        tickRenderer: $.jqplot.CanvasAxisTickRenderer ,
        tickOptions: {
          angle: 0,
        },
    },
    axes: {
      xaxis: {
        renderer: $.jqplot.CategoryAxisRenderer,
		label:'Students	', 
          labelOptions:{
            fontFamily:'Helvetica',
            fontSize: '12pt'
          },
		  tickOptions: {
          angle: -90
        },
      },
      x2axis: {
        renderer: $.jqplot.CategoryAxisRenderer,
		tickOptions: {
          show: false,
		  showLabel: false,
		  textColor: '#ffffff'
        },
				  showTicks: false,
				    showTickMarks: false
      },
      yaxis: {
         label: 'Grade',
                labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
		  tickOptions: {
		  formatter: tickFormatter
		  },
		   tickInterval : 2,
		  
      },
      y2axis: {
        autoscale:true,
		tickOptions: {
		  formatter: tickFormatter
		  },
		  tickInterval : 2,
      }
    },
	 highlighter: {
        show: true,
        sizeAdjust: 7.5,
		tooltipAxes: 'y',
		formatString: 'Grade: %s'
      }
      

  });
});
</script>
<script type='text/javascript'>
					var aps = '<%=avg_aps%>'
					$(document).ready(function () {
					if (aps>0 && aps<54)
					{
					$("#chart1").hide();
					
					}
					else if (aps>79)
					{
					$("#chart2").hide();
					
					}
					else if (aps==0)
					{
					$("#chart2").hide();
					$("#chart1").hide();
					}
				});
				</script>
				
<script type='text/javascript'>				
				$(document).ready(function(){
  var data = [
    ['Above Target', <%=@above.count%>],['On Track', <%=@on_track.count%>], ['One Below Target', <%=@one_below.count%>], 
    ['Below Target', <%=@below.count%>]
  ];
  var plot3 = jQuery.jqplot ('pie_chart', [data], 
    { 
      title:'Comparison to Target Grade',
	  seriesDefaults: {
	  seriesColors: ["rgba(73,165,191,1)","rgba(78,230,55,1)","rgba(254,182,69,1)", "rgba(252,70,70,1)"],
        // Make this a pie chart.
        renderer: jQuery.jqplot.PieRenderer, 
        rendererOptions: {
          // Put data labels on the pie slices.
          // By default, labels show the percentage of the slice.
          showDataLabels: true
        }
      }, 
      legend: { show:true, location: 'e' },
	  highlighter: {
    show: true,
    formatString:'%s', 
    tooltipLocation:'sw', 
    useAxesFormatters:false
}
    }
  );
});

</script>

<script type='text/javascript'>				
				$(document).ready(function(){
  var data = [
	<%(-50..50).each do |i|%>
	<%if @levels.count(i) != 0%>
	['<%=i%> levels', <%=@levels.count(i)%>],  
	<%end%>
    <%end%>
  ];
  var plot4 = jQuery.jqplot ('pie_chart_levels', [data], 
    { 
      title:'Levels of Progress',
	  seriesDefaults: {
	  seriesColors: ["rgba(73,165,191,1)","rgba(78,230,55,1)","rgba(254,182,69,1)", "rgba(252,70,70,1)"],
        // Make this a pie chart.
        renderer: jQuery.jqplot.PieRenderer, 
        rendererOptions: {
          // Put data labels on the pie slices.
          // By default, labels show the percentage of the slice.
          showDataLabels: true,
          
		  
        }
      }, 
      legend: { show:true, location: 'e' },
	  highlighter: {
    show: true,
	
    formatString:'%s', 
    tooltipLocation:'sw', 
    useAxesFormatters:false
}
    }
  );
});

</script>

